package stroom.svg.shared;

import java.io.File;
import java.io.IOException;
import java.io.OutputStream;
import java.io.UncheckedIOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Locale;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.stream.Stream;

/**
 * A main method for walking a directory containing SVG files (some in sub dirs) and
 * doing the following:
 * <ul>
 *     <li>Replacing hex colour codes with a corresponding css colour variable.
 *     This is so we can change the icon colours at runtime.</li>
 *     <li>Output the modified svg files into stroom-app/src/main/resources/ui/images with
 *     the same names and relative paths as the source.</li>
 *     <li>Generate {@link SvgImage} enum containing all the SVGs as string values for use
 *     with inline SVGs in HTML.</li>
 * </ul>
 */
public class SvgImageGen {

    private static final String CORE_SHARED_DIR = "stroom-core-shared";
    private static final String APP_DIR = "stroom-app";

    // Hex colour => css colour variable
    private static final Map<String, String> COLOUR_MAPPINGS = Map.of(
            "#000000", "var(--icon-colour__foreground)",
            "#2196f4", "var(--icon-colour__xsd-background)",
            "#aed581", "var(--icon-colour__xsl-background)",
            "#ce93d8", "var(--icon-colour__xml-background)",
            "#2196f3", "var(--icon-colour__blue)",
            "#4caf50", "var(--icon-colour__green)",
            "#4A4B4C", "var(--icon-colour__grey)",
            "#010101", "currentColor");

    private static final String ENUM_HEADER = """
            package stroom.svg.shared;

            import javax.annotation.processing.Generated;

            @Generated("@@CLASS_NAME@@")
            @SuppressWarnings({"ConcatenationWithEmptyString", "TextBlockMigration", "unused"})
            public enum SvgImage {
                // ================================================================================
                // IMPORTANT - This class is generated by @@CLASS_NAME@@
                // Do not edit it directly!
                // ================================================================================

            """.replace("@@CLASS_NAME@@", SvgImageGen.class.getName());

    private static final String ENUM_FOOTER = """
                private final String relativePathStr;
                private final String svg;

                SvgImage(final String relativePathStr, final String svg) {
                    this.relativePathStr = relativePathStr;
                    this.svg = svg;
                }

                /**
                 * @return The SVG in its XML form.
                 */
                public String getSvg() {
                    return svg;
                }

                /**
                 * @return The path of the SVG file relative to stroom-app/src/main/resources/ui/images/
                 */
                public String getRelativePathStr() {
                    return relativePathStr;
                }
            }
            """;
    private static final Path ENUM_REL_FILE_PATH = Path.of(
            "src", "main", "java", "stroom", "svg", "shared", "SvgImage.java");

    private static final Path UI_RESOURCE_REL_PATH = Path.of(
            "src", "main", "resources", "ui");

    private SvgImageGen() {
    }

    public static void main(final String[] args) {

        Path coreSharedPath = Paths.get(".").resolve(CORE_SHARED_DIR).toAbsolutePath();
        while (!coreSharedPath.getFileName().toString().equals(CORE_SHARED_DIR)) {
            coreSharedPath = coreSharedPath.getParent();
        }

        final Path appPath = coreSharedPath.getParent().resolve(APP_DIR);
        final Path sourceBasePath = appPath.resolve(UI_RESOURCE_REL_PATH)
                .resolve("raw-images");
        final Path destBasePath = appPath.resolve(UI_RESOURCE_REL_PATH)
                .resolve("images");

        final Map<Path, SvgFile> relPathToSvgObjMap = new HashMap<>();
        final Set<String> enumFieldNameSet = new HashSet<>();

        // First transform the raw images.
        deleteDirectory(destBasePath);
        try (final Stream<Path> stream = Files.walk(sourceBasePath)) {
            stream.forEach(sourceFile -> {
                final Path relSourcePath = sourceBasePath.relativize(sourceFile);
                try {
                    String fileName = sourceFile.getFileName().toString();
                    if (fileName.toLowerCase(Locale.ROOT).endsWith(".svg")) {

                        final Path output = destBasePath.resolve(relSourcePath);
                        Files.createDirectories(output.getParent());

                        String xml = Files.readString(sourceFile, StandardCharsets.UTF_8);
                        for (final Entry<String, String> entry : COLOUR_MAPPINGS.entrySet()) {
                            final String hex = entry.getKey();
                            final String cssColourVariable = entry.getValue();
                            xml = xml.replaceAll(hex, cssColourVariable);
                        }
                        final String enumFieldName = pathToEnumFieldName(relSourcePath);
                        final boolean isNewName = enumFieldNameSet.add(enumFieldName);
                        if (!isNewName) {
                            System.err.println("Enum field name clash: " + enumFieldName);
                        }

                        final SvgFile svgFile = new SvgFile(relSourcePath,
                                enumFieldName,
                                xml);

                        if (Files.exists(output)) {
                            System.err.println("File exists: " + output);
                        } else {
                            System.out.println(relSourcePath + " => " + output);
                            Files.writeString(output, xml);
                            relPathToSvgObjMap.put(relSourcePath, svgFile);
                        }
                    } else if (fileName.toLowerCase(Locale.ROOT).endsWith(".png")) {
                        final Path output = destBasePath.resolve(relSourcePath);
                        Files.createDirectories(output.getParent());

                        if (Files.exists(output)) {
                            System.err.println("File exists: " + output);
                        } else {
                            Files.copy(sourceFile, output);
                        }
                    }
                } catch (final IOException e) {
                    throw new UncheckedIOException(e);
                }
            });

        } catch (final IOException e) {
            throw new UncheckedIOException(e);
        }

        // Now build the enum that contains all the XML content for using SVS inline in HTML
        final StringBuilder sb = new StringBuilder()
                .append(ENUM_HEADER);

        relPathToSvgObjMap.entrySet()
                .stream()
                .sorted(Comparator.comparing(entry -> entry.getValue().enumFieldName))
                .forEach(entry -> {
                    final SvgFile svgFile = entry.getValue();
                    sb.append("    ");
                    sb.append(svgFile.enumFieldName);
                    sb.append("(\"");
                    sb.append(svgFile.relPath.toString());
                    sb.append("\", \"\" +\n");

                    final String[] parts = svgFile.xml.split("\n");
                    for (String part : parts) {
                        if (part.length() == 0) {
                            sb.append("            \"\\n\" +\n");
                        } else {
                            while (part.length() > 0) {
                                int size = Math.min(80, part.length());
                                String line = part.substring(0, size);
                                part = part.substring(size);
                                line = line.replaceAll("\"", "\\\\\"");
                                line = line.replaceAll("\t", " ");
                                sb.append("            \"");
                                sb.append(line);
                                if (part.length() > 0) {
                                    sb.append("\" +\n");
                                }
                            }
                            sb.append("\\n\" +\n");
                        }
                    }
                    sb.append("            \"\"),\n\n");
                });

        sb.replace(sb.length() - 3, sb.length() - 1, ";\n\n");
        sb.append(ENUM_FOOTER);

        final Path outPath = coreSharedPath.resolve(ENUM_REL_FILE_PATH);
        try (final OutputStream outputStream = Files.newOutputStream(outPath)) {
            outputStream.write(sb.toString().getBytes(StandardCharsets.UTF_8));
            System.out.println("Written enum file " + outPath.toAbsolutePath());
        } catch (final IOException e) {
            throw new UncheckedIOException(e);
        }
    }

    static void deleteDirectory(Path directoryToBeDeleted) {
        try {
            if (Files.isDirectory(directoryToBeDeleted)) {
                Files.walk(directoryToBeDeleted)
                        .sorted(Comparator.reverseOrder())
                        .map(Path::toFile)
                        .forEach(File::delete);
            }
        } catch (IOException e) {
            throw new UncheckedIOException(e);
        }
    }

    private static String pathToEnumFieldName(final Path relPath) {
        final StringBuilder sb = new StringBuilder();
        for (int i = 0; i < relPath.getNameCount(); i++) {
            if (sb.length() > 0) {
                sb.append("_");
            }
            sb.append(relPath.getName(i));
        }
        String name = sb.toString();
        name = name.substring(0, name.length() - 4)
                .replaceAll("([a-z])([A-Z])", "$1_$2")
                .toUpperCase(Locale.ROOT)
                .replaceAll("[^A-Z0-9]", "_")
                .replaceAll("_+", "_")
                .replaceAll("^_+", "")
                .replaceAll("_+$", "");

        return name;
    }


    // --------------------------------------------------------------------------------


    private record SvgFile(
            Path relPath,
            String enumFieldName,
            String xml) {

    }
}
